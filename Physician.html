<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BÃ¡c sÄ© - Dashboard</title>
  <link rel="stylesheet" href="Physician.css"/>
</head>
<body>
  <div class="dashboard">
    <header>
      <h1>Há»‡ thá»‘ng há»— trá»£ cháº©n Ä‘oÃ¡n</h1>
      <p>BÃ¡c sÄ©: BS. Nguyá»…n VÄƒn A</p>
    </header>

    <nav class="tabs">
      <button class="tab active" onclick="showTab(0)">ğŸ“‹ Há»“ sÆ¡</button>
      <button class="tab" onclick="showTab(1)">ğŸ“ YÃªu cáº§u chá»¥p</button>
      <button class="tab" onclick="showTab(2)">ğŸ–¼ï¸ áº¢nh & AI</button>
      <button class="tab" onclick="showTab(3)">ğŸ“„ BÃ¡o cÃ¡o</button>
    </nav>

    <main>
      <!-- Tab 1: Há»“ sÆ¡ bá»‡nh nhÃ¢n -->
      <section class="tab-content active">
        <h2>Há»“ sÆ¡ bá»‡nh nhÃ¢n</h2>
        <input type="search" placeholder="TÃ¬m theo tÃªn hoáº·c mÃ£ BN...">
        <ul class="patient-list">
          <li>BN001 - Nguyá»…n VÄƒn B - Nam - 65 tuá»•i</li>
          <li>BN002 - Tráº§n Thá»‹ C - Ná»¯ - 72 tuá»•i</li>
          <li>BN003 - LÃª VÄƒn D - Nam - 58 tuá»•i</li>
        </ul>
      </section>

      <!-- Tab 2: YÃªu cáº§u chá»¥p áº£nh -->
      <section class="tab-content">
        <h2>Táº¡o yÃªu cáº§u chá»¥p áº£nh</h2>
        <form id="scanRequestForm">
          <label>Bá»‡nh nhÃ¢n</label>
          <input type="text" id="patientId" placeholder="Nháº­p mÃ£ bá»‡nh nhÃ¢n" required/>

          <label>Loáº¡i chá»¥p</label>
          <select id="scanType" required>
            <option>CT Scan</option>
            <option>MRI</option>
            <option>X-ray</option>
          </select>

          <label>Ghi chÃº</label>
          <textarea id="note" rows="4" placeholder="Nháº­p lÃ½ do / vÃ¹ng cáº§n chá»¥p"></textarea>

          <button type="submit">Gá»­i yÃªu cáº§u</button>
        </form>
      </section>

      <!-- Tab 3: áº¢nh DICOM + AI -->
      <section class="tab-content">
        <h2>áº¢nh DICOM & PhÃ¢n tÃ­ch AI</h2>

        <form id="upload-form">
          <label>Chá»n áº£nh DICOM:</label>
          <input type="file" id="dicom-file" accept=".dcm" required />
          <button type="submit">ğŸ“¤ Gá»­i áº£nh Ä‘áº¿n AI</button>
        </form>

        <h4>Káº¿t quáº£ cháº©n Ä‘oÃ¡n</h4>
        <pre id="ai-result-box">ChÆ°a cÃ³ káº¿t quáº£...</pre>
      </section>

      <!-- Tab 4: BÃ¡o cÃ¡o cháº©n Ä‘oÃ¡n -->
      <section class="tab-content">
        <h2>Táº¡o bÃ¡o cÃ¡o cháº©n Ä‘oÃ¡n</h2>
        <input type="text" id="reportPatientId" placeholder="MÃ£ bá»‡nh nhÃ¢n" required />
        <textarea id="reportContent" rows="6" placeholder="Nháº­p ná»™i dung bÃ¡o cÃ¡o..." required></textarea>
        <div class="report-actions">
          <button onclick="submitReport()">ğŸ’¾ LÆ°u ná»™i bá»™</button>
          <button>â¬‡ï¸ Xuáº¥t PDF</button>
        </div>
      </section>
    </main>
  </div>

  <script>
    const tabs = document.querySelectorAll('.tab');
    const contents = document.querySelectorAll('.tab-content');

    function showTab(index) {
      tabs.forEach((tab, i) => tab.classList.toggle('active', i === index));
      contents.forEach((content, i) => content.classList.toggle('active', i === index));
    }

    // ğŸ¯ Gá»­i yÃªu cáº§u chá»¥p áº£nh tá»« bÃ¡c sÄ© lÃªn backend
    document.getElementById("scanRequestForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const data = {
        patientId: document.getElementById("patientId").value,
        scanType: document.getElementById("scanType").value,
        note: document.getElementById("note").value
      };

      try {
        const response = await fetch("http://localhost:5062/api/scanrequests", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) throw new Error("Gá»­i tháº¥t báº¡i!");

        const result = await response.json();
        alert("âœ… Gá»­i thÃ nh cÃ´ng! ID yÃªu cáº§u: " + result.id);
      } catch (error) {
        console.error(error);
        alert("âŒ KhÃ´ng thá»ƒ gá»­i yÃªu cáº§u. Vui lÃ²ng kiá»ƒm tra láº¡i.");
      }
    });

    // ğŸ“¤ Gá»­i áº£nh Ä‘áº¿n Flask AI vÃ  nháº­n káº¿t quáº£
    document.getElementById("upload-form").addEventListener("submit", async function (e) {
      e.preventDefault();

      const fileInput = document.getElementById("dicom-file");
      const file = fileInput.files[0];
      if (!file) return alert("Vui lÃ²ng chá»n áº£nh .dcm");

      const formData = new FormData();
      formData.append("dicom", file);

      try {
        const response = await fetch("http://localhost:5062/api/scanrequests/analyze", {
          method: "POST",
          body: formData
        });

        if (!response.ok) throw new Error("PhÃ¢n tÃ­ch tháº¥t báº¡i");

        const result = await response.json();
        document.getElementById("ai-result-box").textContent = JSON.stringify(result, null, 2);
      } catch (error) {
        document.getElementById("ai-result-box").textContent = "âŒ Lá»—i: " + error.message;
      }
    });

    // ğŸ“„ Gá»­i bÃ¡o cÃ¡o
    async function submitReport() {
      const patientId = document.getElementById("reportPatientId").value;
      const content = document.getElementById("reportContent").value;

      if (!patientId || !content) {
        alert("Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin.");
        return;
      }

      const data = { patientId, content };

      try {
        const response = await fetch("http://localhost:5062/api/diagnosisreports", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });

        if (!response.ok) throw new Error("KhÃ´ng thá»ƒ gá»­i bÃ¡o cÃ¡o.");

        const result = await response.json();
        alert("âœ… BÃ¡o cÃ¡o Ä‘Ã£ lÆ°u! ID: " + result.id);
      } catch (error) {
        console.error(error);
        alert("âŒ Lá»—i khi gá»­i bÃ¡o cÃ¡o.");
      }
    }
  </script>
</body>
</html>
